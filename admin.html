<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 留學顧問 - 管理員儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.__CONFIG__ = {
            API_BASE: 'https://aistudentbackend.zeabur.app/api/v1'
        };
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 標題 -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AI 留學顧問 - 管理員儀表板</h1>
            <p class="text-gray-600">用戶資料管理與知識庫系統</p>
        </div>

        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6 fade-in">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">總用戶數</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalProfiles">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 fade-in">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">聯繫請求</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalHandoffs">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 fade-in">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">熱門國家</p>
                        <p class="text-2xl font-bold text-gray-900" id="topCountry">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 fade-in">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">學位分布</p>
                        <p class="text-2xl font-bold text-gray-900" id="topDegree">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">國家分布</h3>
                <canvas id="countryChart" width="400" height="200"></canvas>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">學位分布</h3>
                <canvas id="degreeChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- 用戶列表 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">最近用戶</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學校</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目標國家</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">專業</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GPA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">註冊時間</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 用戶數據將在這裡動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 知識庫搜尋 -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">知識庫搜尋</h3>
            <div class="flex gap-4 mb-4">
                <input type="text" id="knowledgeSearch" placeholder="搜尋知識庫..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="searchKnowledge()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    搜尋
                </button>
            </div>
            <div id="knowledgeResults" class="space-y-4">
                <!-- 搜尋結果將在這裡顯示 -->
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;

        // 載入儀表板數據
        async function loadDashboard() {
            try {
                const response = await fetch(`${window.__CONFIG__.API_BASE}/admin/dashboard`);
                const result = await response.json();
                
                if (result.ok) {
                    dashboardData = result.data;
                    updateDashboard();
                } else {
                    console.error('載入儀表板數據失敗:', result.error);
                }
            } catch (error) {
                console.error('載入儀表板數據錯誤:', error);
            }
        }

        // 更新儀表板
        function updateDashboard() {
            if (!dashboardData) return;

            // 更新統計卡片
            document.getElementById('totalProfiles').textContent = dashboardData.totalProfiles;
            document.getElementById('totalHandoffs').textContent = dashboardData.totalHandoffs;
            
            // 找出最熱門的國家和學位
            const topCountry = Object.entries(dashboardData.profilesByCountry)
                .sort(([,a], [,b]) => b - a)[0];
            const topDegree = Object.entries(dashboardData.profilesByDegree)
                .sort(([,a], [,b]) => b - a)[0];
            
            document.getElementById('topCountry').textContent = topCountry ? `${topCountry[0]} (${topCountry[1]})` : '-';
            document.getElementById('topDegree').textContent = topDegree ? `${topDegree[0]} (${topDegree[1]})` : '-';

            // 更新圖表
            updateCharts();
            
            // 更新用戶列表
            updateUserTable();
        }

        // 更新圖表
        function updateCharts() {
            // 國家分布圖
            const countryCtx = document.getElementById('countryChart').getContext('2d');
            new Chart(countryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dashboardData.profilesByCountry),
                    datasets: [{
                        data: Object.values(dashboardData.profilesByCountry),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                            '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // 學位分布圖
            const degreeCtx = document.getElementById('degreeChart').getContext('2d');
            new Chart(degreeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dashboardData.profilesByDegree),
                    datasets: [{
                        label: '用戶數量',
                        data: Object.values(dashboardData.profilesByDegree),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 更新用戶表格
        function updateUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            dashboardData.recentProfiles.forEach(profile => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${profile.student_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${profile.high_school}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${profile.countries.join(', ')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${profile.intended_major}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${profile.gpa}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(profile.created_at).toLocaleDateString('zh-TW')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="viewProfile('${profile.id}')" 
                                class="text-blue-600 hover:text-blue-900">
                            查看詳情
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 查看用戶詳情
        async function viewProfile(profileId) {
            try {
                const response = await fetch(`${window.__CONFIG__.API_BASE}/admin/profile/${profileId}`);
                const result = await response.json();
                
                if (result.ok) {
                    const profile = result.data.profile;
                    alert(`用戶詳情：\n姓名：${profile.student_name}\n學校：${profile.high_school}\n專業：${profile.intended_major}\nGPA：${profile.gpa}\n目標國家：${profile.countries.join(', ')}\n預算：$${profile.budget.toLocaleString()}`);
                } else {
                    alert('載入用戶詳情失敗');
                }
            } catch (error) {
                console.error('載入用戶詳情錯誤:', error);
                alert('載入用戶詳情錯誤');
            }
        }

        // 搜尋知識庫
        async function searchKnowledge() {
            const query = document.getElementById('knowledgeSearch').value.trim();
            if (!query) return;

            try {
                const response = await fetch(`${window.__CONFIG__.API_BASE}/knowledge/search?q=${encodeURIComponent(query)}`);
                const result = await response.json();
                
                if (result.ok) {
                    displayKnowledgeResults(result.data.results);
                } else {
                    console.error('搜尋知識庫失敗:', result.error);
                }
            } catch (error) {
                console.error('搜尋知識庫錯誤:', error);
            }
        }

        // 顯示知識庫搜尋結果
        function displayKnowledgeResults(results) {
            const container = document.getElementById('knowledgeResults');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<p class="text-gray-500">沒有找到相關結果</p>';
                return;
            }

            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4';
                
                if (item.type === 'faq') {
                    div.innerHTML = `
                        <h4 class="font-semibold text-gray-900 mb-2">Q: ${item.question}</h4>
                        <p class="text-gray-700">${item.answer}</p>
                        <span class="inline-block mt-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">FAQ</span>
                    `;
                } else if (item.type === 'knowledge') {
                    div.innerHTML = `
                        <h4 class="font-semibold text-gray-900 mb-2">${item.title}</h4>
                        <p class="text-gray-700">${item.content}</p>
                        <span class="inline-block mt-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded">知識庫</span>
                    `;
                }
                
                container.appendChild(div);
            });
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });
    </script>
</body>
</html>
