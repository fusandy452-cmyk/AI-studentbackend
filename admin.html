<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç•™å­¸é¡§å• - å¾Œå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="min-h-screen">
        <!-- å´é‚Šæ¬„ -->
        <div class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white">
            <div class="p-6">
                <h1 class="text-xl font-bold">AI ç•™å­¸é¡§å•</h1>
                <p class="text-gray-300 text-sm">å¾Œå°ç®¡ç†ç³»çµ±</p>
            </div>
            <nav class="mt-8">
                <a href="#dashboard" onclick="showSection('dashboard')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ“Š å„€è¡¨æ¿
                </a>
                <a href="#users" onclick="showSection('users')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ‘¥ ç”¨æˆ¶ç®¡ç†
                </a>
                <a href="#profiles" onclick="showSection('profiles')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ“‹ ç”¨æˆ¶è¨­å®š
                </a>
                <a href="#messages" onclick="showSection('messages')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ’¬ èŠå¤©è¨˜éŒ„
                </a>
                <a href="#stats" onclick="showSection('stats')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ“ˆ ä½¿ç”¨çµ±è¨ˆ
                </a>
                <a href="#export" onclick="showSection('export')" class="nav-item block px-6 py-3 hover:bg-gray-700 transition-colors">
                    ğŸ“¤ è³‡æ–™åŒ¯å‡º
                </a>
            </nav>
        </div>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="ml-64">
            <!-- é ‚éƒ¨å°èˆª -->
            <header class="bg-white shadow-sm border-b border-gray-200 p-4">
                <div class="flex justify-between items-center">
                    <h2 id="page-title" class="text-2xl font-semibold text-gray-800">å„€è¡¨æ¿</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500" id="last-updated">æœ€å¾Œæ›´æ–°: --</span>
                        <button onclick="refreshData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            ğŸ”„ é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>
            </header>

            <!-- å…§å®¹å€åŸŸ -->
            <main class="p-6">
                <!-- å„€è¡¨æ¿ -->
                <div id="dashboard-section" class="section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <span class="text-2xl">ğŸ‘¥</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">ç¸½ç”¨æˆ¶æ•¸</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-users">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full">
                                    <span class="text-2xl">ğŸ“‹</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">ç”¨æˆ¶è¨­å®š</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-profiles">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-full">
                                    <span class="text-2xl">ğŸ’¬</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">èŠå¤©è¨Šæ¯</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-messages">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <span class="text-2xl">ğŸ“</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">å­¸ç”Ÿç”¨æˆ¶</p>
                                    <p class="text-2xl font-bold text-gray-800" id="student-count">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4">æœ€è¿‘ç”¨æˆ¶</h3>
                            <div id="recent-users" class="space-y-3">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4">æœ€è¿‘è¨Šæ¯</h3>
                            <div id="recent-messages" class="space-y-3">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ¶ç®¡ç† -->
                <div id="users-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">ç”¨æˆ¶åˆ—è¡¨</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ¶</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨­å®šæ•¸</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨Šæ¯æ•¸</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨»å†Šæ™‚é–“</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table" class="bg-white divide-y divide-gray-200">
                                    <!-- å‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ¶è¨­å®š -->
                <div id="profiles-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">ç”¨æˆ¶è¨­å®šåˆ—è¡¨</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨­å®šID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ¶è§’è‰²</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®æ¨™åœ‹å®¶</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å»ºç«‹æ™‚é–“</th>
                                    </tr>
                                </thead>
                                <tbody id="profiles-table" class="bg-white divide-y divide-gray-200">
                                    <!-- å‹•æ…‹è¼‰å…¥ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©è¨˜éŒ„ -->
                <div id="messages-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold">èŠå¤©è¨˜éŒ„</h3>
                        </div>
                        <div class="p-6">
                            <div id="messages-list" class="space-y-4">
                                <!-- å‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨çµ±è¨ˆ -->
                <div id="stats-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold mb-4">ä½¿ç”¨çµ±è¨ˆ</h3>
                        <canvas id="stats-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- è³‡æ–™åŒ¯å‡º -->
                <div id="export-section" class="section hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold mb-4">è³‡æ–™åŒ¯å‡º</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯å‡ºé¸é …</label>
                                <select id="export-type" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="all">æ‰€æœ‰è³‡æ–™</option>
                                    <option value="users">ç”¨æˆ¶è³‡æ–™</option>
                                    <option value="profiles">ç”¨æˆ¶è¨­å®š</option>
                                    <option value="messages">èŠå¤©è¨˜éŒ„</option>
                                    <option value="stats">ä½¿ç”¨çµ±è¨ˆ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç‰¹å®šç”¨æˆ¶ (å¯é¸)</label>
                                <input type="text" id="export-user-id" placeholder="è¼¸å…¥ç”¨æˆ¶ID" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <button onclick="exportData()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                ğŸ“¤ åŒ¯å‡ºè³‡æ–™
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        var currentSection = 'dashboard';
        var apiBase = window.location.origin + '/api/v1';
        var jwt = 'fake-jwt-token-for-testing'; // ç®¡ç†å“¡ token

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
            loadDashboard();
        });

        // é¡¯ç¤ºæŒ‡å®šå€æ®µ
        function showSection(section) {
            // éš±è—æ‰€æœ‰å€æ®µ
            var sections = document.querySelectorAll('.section');
            for (var i = 0; i < sections.length; i++) {
                sections[i].classList.add('hidden');
            }

            // é¡¯ç¤ºæŒ‡å®šå€æ®µ
            document.getElementById(section + '-section').classList.remove('hidden');
            currentSection = section;

            // æ›´æ–°å°èˆªç‹€æ…‹
            var navItems = document.querySelectorAll('.nav-item');
            for (var j = 0; j < navItems.length; j++) {
                navItems[j].classList.remove('bg-gray-700');
            }
            event.target.classList.add('bg-gray-700');

            // æ›´æ–°é é¢æ¨™é¡Œ
            var titles = {
                'dashboard': 'å„€è¡¨æ¿',
                'users': 'ç”¨æˆ¶ç®¡ç†',
                'profiles': 'ç”¨æˆ¶è¨­å®š',
                'messages': 'èŠå¤©è¨˜éŒ„',
                'stats': 'ä½¿ç”¨çµ±è¨ˆ',
                'export': 'è³‡æ–™åŒ¯å‡º'
            };
            document.getElementById('page-title').textContent = titles[section];

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'profiles':
                    loadProfiles();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'stats':
                    loadStats();
                    break;
            }
        }

        // è¼‰å…¥å„€è¡¨æ¿è³‡æ–™
        function loadDashboard() {
            fetch(apiBase + '/admin/dashboard', {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    var data = result.data;
                    var summary = data.summary;

                    // æ›´æ–°çµ±è¨ˆæ•¸å­—
                    document.getElementById('total-users').textContent = summary.total_users;
                    document.getElementById('total-profiles').textContent = summary.total_profiles;
                    document.getElementById('total-messages').textContent = summary.total_messages;
                    document.getElementById('student-count').textContent = summary.student_count;

                    // æ›´æ–°æœ€è¿‘ç”¨æˆ¶
                    var recentUsersHtml = '';
                    for (var i = 0; i < data.recent_users.length; i++) {
                        var user = data.recent_users[i];
                        recentUsersHtml += '<div class="flex items-center space-x-3">';
                        recentUsersHtml += '<div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">';
                        recentUsersHtml += '<span class="text-sm">' + (user.name ? user.name.charAt(0) : 'U') + '</span>';
                        recentUsersHtml += '</div>';
                        recentUsersHtml += '<div>';
                        recentUsersHtml += '<p class="text-sm font-medium">' + (user.name || 'Unknown') + '</p>';
                        recentUsersHtml += '<p class="text-xs text-gray-500">' + formatDate(user.created_at) + '</p>';
                        recentUsersHtml += '</div>';
                        recentUsersHtml += '</div>';
                    }
                    document.getElementById('recent-users').innerHTML = recentUsersHtml;

                    // æ›´æ–°æœ€è¿‘è¨Šæ¯
                    var recentMessagesHtml = '';
                    for (var j = 0; j < data.recent_messages.length; j++) {
                        var message = data.recent_messages[j];
                        recentMessagesHtml += '<div class="border-l-4 border-blue-500 pl-3">';
                        recentMessagesHtml += '<p class="text-sm">' + (message.message_content ? message.message_content.substring(0, 50) + '...' : 'No content') + '</p>';
                        recentMessagesHtml += '<p class="text-xs text-gray-500">' + formatDate(message.created_at) + ' â€¢ ' + message.message_type + '</p>';
                        recentMessagesHtml += '</div>';
                    }
                    document.getElementById('recent-messages').innerHTML = recentMessagesHtml;

                    updateLastUpdated();
                }
            })
            .catch(function(error) {
                console.error('Dashboard load error:', error);
            });
        }

        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        function loadUsers() {
            fetch(apiBase + '/admin/users', {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    var usersHtml = '';
                    for (var i = 0; i < result.data.length; i++) {
                        var user = result.data[i];
                        usersHtml += '<tr>';
                        usersHtml += '<td class="px-6 py-4 whitespace-nowrap">';
                        usersHtml += '<div class="flex items-center">';
                        usersHtml += '<div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-3">';
                        usersHtml += '<span class="text-sm">' + (user.name ? user.name.charAt(0) : 'U') + '</span>';
                        usersHtml += '</div>';
                        usersHtml += '<div>';
                        usersHtml += '<div class="text-sm font-medium text-gray-900">' + (user.name || 'Unknown') + '</div>';
                        usersHtml += '<div class="text-sm text-gray-500">ID: ' + user.user_id + '</div>';
                        usersHtml += '</div>';
                        usersHtml += '</div>';
                        usersHtml += '</td>';
                        usersHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + (user.email || '--') + '</td>';
                        usersHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + user.profile_count + '</td>';
                        usersHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + user.message_count + '</td>';
                        usersHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + formatDate(user.created_at) + '</td>';
                        usersHtml += '</tr>';
                    }
                    document.getElementById('users-table').innerHTML = usersHtml;
                    updateLastUpdated();
                }
            })
            .catch(function(error) {
                console.error('Users load error:', error);
            });
        }

        // è¼‰å…¥ç”¨æˆ¶è¨­å®šåˆ—è¡¨
        function loadProfiles() {
            fetch(apiBase + '/admin/profiles', {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    var profilesHtml = '';
                    for (var i = 0; i < result.data.length; i++) {
                        var profile = result.data[i];
                        var name = profile.student_name || profile.parent_name || 'Unknown';
                        var countries = Array.isArray(profile.countries) ? profile.countries.join(', ') : profile.countries || '--';
                        
                        profilesHtml += '<tr>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + profile.profile_id + '</td>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap">';
                        profilesHtml += '<span class="px-2 py-1 text-xs font-semibold rounded-full ' + (profile.user_role === 'student' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800') + '">';
                        profilesHtml += profile.user_role === 'student' ? 'å­¸ç”Ÿ' : 'å®¶é•·';
                        profilesHtml += '</span>';
                        profilesHtml += '</td>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + name + '</td>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + countries + '</td>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">' + (profile.budget ? '$' + profile.budget : '--') + '</td>';
                        profilesHtml += '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">' + formatDate(profile.created_at) + '</td>';
                        profilesHtml += '</tr>';
                    }
                    document.getElementById('profiles-table').innerHTML = profilesHtml;
                    updateLastUpdated();
                }
            })
            .catch(function(error) {
                console.error('Profiles load error:', error);
            });
        }

        // è¼‰å…¥èŠå¤©è¨˜éŒ„
        function loadMessages() {
            fetch(apiBase + '/admin/messages?limit=50', {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    var messagesHtml = '';
                    for (var i = 0; i < result.data.length; i++) {
                        var message = result.data[i];
                        var isUser = message.message_type === 'user';
                        
                        messagesHtml += '<div class="flex ' + (isUser ? 'justify-end' : 'justify-start') + ' mb-4">';
                        messagesHtml += '<div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ' + (isUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800') + '">';
                        messagesHtml += '<p class="text-sm">' + (message.message_content || 'No content') + '</p>';
                        messagesHtml += '<p class="text-xs mt-1 opacity-75">' + formatDate(message.created_at) + ' â€¢ ' + message.language + '</p>';
                        messagesHtml += '</div>';
                        messagesHtml += '</div>';
                    }
                    document.getElementById('messages-list').innerHTML = messagesHtml;
                    updateLastUpdated();
                }
            })
            .catch(function(error) {
                console.error('Messages load error:', error);
            });
        }

        // è¼‰å…¥ä½¿ç”¨çµ±è¨ˆ
        function loadStats() {
            fetch(apiBase + '/admin/stats?days=30', {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    // é€™è£¡å¯ä»¥æ·»åŠ åœ–è¡¨é¡¯ç¤ºé‚è¼¯
                    console.log('Stats data:', result.data);
                    updateLastUpdated();
                }
            })
            .catch(function(error) {
                console.error('Stats load error:', error);
            });
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            var exportType = document.getElementById('export-type').value;
            var userId = document.getElementById('export-user-id').value;
            
            var url = apiBase + '/admin/export';
            if (userId) {
                url += '?user_id=' + userId;
            }
            
            fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + jwt
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.ok) {
                    // ä¸‹è¼‰ JSON æª”æ¡ˆ
                    var dataStr = JSON.stringify(result.data, null, 2);
                    var dataBlob = new Blob([dataStr], {type: 'application/json'});
                    var url = URL.createObjectURL(dataBlob);
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = 'ai_study_advisor_export_' + new Date().toISOString().split('T')[0] + '.json';
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('åŒ¯å‡ºå¤±æ•—: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(function(error) {
                console.error('Export error:', error);
                alert('åŒ¯å‡ºå¤±æ•—');
            });
        }

        // é‡æ–°æ•´ç†è³‡æ–™
        function refreshData() {
            showSection(currentSection);
        }

        // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = 'æœ€å¾Œæ›´æ–°: ' + new Date().toLocaleString('zh-TW');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '--';
            var date = new Date(dateString);
            return date.toLocaleString('zh-TW');
        }
    </script>
</body>
</html>
